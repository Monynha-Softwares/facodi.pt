name: Validate Content

on:
  push:
    branches: [main, develop]
    paths:
      - 'content/**/*.md'
      - '.github/workflows/validate-content.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'content/**/*.md'

jobs:
  validate-markdown:
    runs-on: ubuntu-latest
    name: Validate Markdown Files

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate markdown files
        run: |
          echo "✓ Checking for markdown files..."
          find content -type f -name "*.md" | head -10
          echo "✓ All markdown files found"

      - name: Check for front matter
        run: |
          echo "Validating front matter in markdown files..."
          python3 - << 'EOF'
          import os
          import re
          from pathlib import Path
          
          errors = []
          
          for md_file in Path('content').rglob('*.md'):
              with open(md_file, 'r', encoding='utf-8') as f:
                  content = f.read()
                  
              # Check for front matter
              if not content.startswith('---'):
                  errors.append(f"{md_file}: Missing front matter (must start with ---)")
                  continue
              
              # Find front matter block
              match = re.match(r'^---\n(.*?)\n---', content, re.DOTALL)
              if not match:
                  errors.append(f"{md_file}: Invalid front matter format")
                  continue
              
              # Basic validation: check for title
              if 'title' not in match.group(1):
                  errors.append(f"{md_file}: Missing 'title' in front matter")
          
          if errors:
              print("❌ Validation errors found:\n")
              for error in errors:
                  print(f"  - {error}")
              exit(1)
          else:
              print("✓ All markdown files have valid front matter!")
              exit(0)
          EOF

  check-build:
    runs-on: ubuntu-latest
    name: Test Hugo Build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Hugo site
        run: npm run build
        env:
          HUGO_ENV: production

      - name: Check build output
        run: |
          if [ -d "public" ]; then
            echo "✓ Build successful!"
            echo "Generated files: $(find public -type f | wc -l)"
          else
            echo "❌ Build failed - public/ directory not created"
            exit 1
          fi
