{{ define "main" }}
{{ $courseCode := .Params.code }}
{{ $planVersion := .Params.plan_version }}
{{ $matchingUCs := where (where site.AllPages "Params.layout" "uc") "Params.course_code" $courseCode }}
{{ if $planVersion }}
  {{ $matchingUCs = where $matchingUCs "Params.plan_version" $planVersion }}
{{ end }}

<section class="section container-fluid mt-n3 pb-3">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">
        <div>
          <span class="badge bg-primary-subtle text-primary fw-semibold mb-2">{{ $planVersion }}</span>
          <h1 class="display-5 fw-semibold" id="course-title">{{ .Params.title | default .Title }}</h1>
          {{ with .Params.summary }}<p class="lead text-muted" id="course-summary">{{ . }}</p>{{ end }}
        </div>
        <div class="card shadow-sm w-100 w-lg-auto">
          <div class="card-body">
            <dl class="row mb-0 small" id="course-meta">
              <dt class="col-5">Grau</dt>
              <dd class="col-7 text-capitalize">{{ .Params.degree }}</dd>
              <dt class="col-5">ECTS</dt>
              <dd class="col-7">{{ .Params.ects_total }}</dd>
              <dt class="col-5">Semestres</dt>
              <dd class="col-7">{{ .Params.duration_semesters }}</dd>
              <dt class="col-5">Instituição</dt>
              <dd class="col-7">{{ .Params.institution }}</dd>
              <dt class="col-5">Escola</dt>
              <dd class="col-7">{{ .Params.school }}</dd>
              <dt class="col-5">Idioma</dt>
              <dd class="col-7">{{ .Params.language }}</dd>
            </dl>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="section section-md">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-10" id="course-content">
        {{ .Content }}
      </div>
    </div>
  </div>
</section>

<section class="section section-md bg-light">
  <div class="container">
    <div class="row mb-4">
      <div class="col-12 d-flex justify-content-between align-items-center">
        <h2 class="h4 mb-0">Unidades Curriculares</h2>
        <span class="badge bg-primary-subtle text-primary">{{ len $matchingUCs }}</span>
      </div>
    </div>
    <div class="row g-4" id="uc-list">
      {{ range sort $matchingUCs "Params.semester" }}
      <div class="col-md-6 d-flex">
        <article class="card shadow-sm w-100 h-100">
          <div class="card-body d-flex flex-column">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h3 class="h5 mb-0"><a class="text-decoration-none" href="{{ .RelPermalink }}">{{ .Params.title | default .Title }}</a></h3>
              <span class="badge bg-dark text-white">{{ .Params.semester }}º semestre</span>
            </div>
            {{ with .Params.description }}<p class="text-muted">{{ . }}</p>{{ end }}
            <dl class="row small text-muted">
              <dt class="col-6">ECTS</dt>
              <dd class="col-6">{{ .Params.ects }}</dd>
              <dt class="col-6">Idioma</dt>
              <dd class="col-6 text-uppercase">{{ .Params.language }}</dd>
            </dl>
            {{ with .Params.learning_outcomes }}
            <h4 class="h6 mt-3">Resultados de aprendizagem</h4>
            <ul class="small">
              {{ range first 3 . }}<li>{{ . }}</li>{{ end }}
            </ul>
            {{ end }}
            <div class="mt-auto">
              <a class="btn btn-outline-primary w-100" href="{{ .RelPermalink }}">Ver detalhes</a>
            </div>
          </div>
        </article>
      </div>
      {{ end }}
    </div>
  </div>
</section>

{{ $payloadUCs := slice }}
{{ range sort $matchingUCs "Params.semester" }}
  {{ $ucTopics := where (where site.RegularPages "Params.layout" "topic") "Params.uc_code" .Params.code }}
  {{ if $planVersion }}
    {{ $ucTopics = where $ucTopics "Params.plan_version" $planVersion }}
  {{ end }}
  {{ $topicsData := slice }}
  {{ range sort $ucTopics "Title" }}
    {{ $topicsData = $topicsData | append (dict "slug" .Params.slug "title" .Title "summary" .Params.summary "tags" .Params.tags "youtube_playlists" .Params.youtube_playlists "course_code" .Params.course_code "uc_code" .Params.uc_code "plan_version" .Params.plan_version "permalink" .RelPermalink "content_markdown" .RawContent) }}
  {{ end }}
  {{ $payloadUCs = $payloadUCs | append (dict "code" .Params.code "title" (.Params.title | default .Title) "description" .Params.description "ects" .Params.ects "semester" .Params.semester "language" .Params.language "prerequisites" .Params.prerequisites "learning_outcomes" .Params.learning_outcomes "youtube_playlists" .Params.youtube_playlists "topics" $topicsData "permalink" .RelPermalink "content_markdown" .RawContent) }}
{{ end }}
{{ $coursePayload := dict "course" (dict "code" $courseCode "title" (.Params.title | default .Title) "degree" .Params.degree "ects_total" .Params.ects_total "duration_semesters" .Params.duration_semesters "plan_version" $planVersion "institution" .Params.institution "school" .Params.school "language" .Params.language "summary" .Params.summary "content_markdown" .RawContent "permalink" .RelPermalink) "ucs" $payloadUCs }}
<script id="facodi-payload" type="application/json">{{ $coursePayload | jsonify }}</script>
{{ end }}
