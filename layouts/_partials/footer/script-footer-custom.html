{{- $supabaseUrl := or (getenv "SUPABASE_URL") site.Params.facodi.supabaseUrl -}}
{{- $supabaseAnon := or (getenv "SUPABASE_ANON_KEY") site.Params.facodi.supabaseAnonKey -}}
{{- $locales := site.Params.facodi.locales | default (slice (dict "code" "pt" "label" "PortuguÃªs" "google" "pt")) -}}
{{- $defaultLocale := site.Params.facodi.defaultLocale | default "pt" -}}
{{- $translationBundle := dict -}}
{{- range $locale := $locales -}}
  {{- $code := $locale.code | default $locale.Code | lower -}}
  {{- $filePath := printf "i18n/%s.json" $code -}}
  {{- $entries := transform.Unmarshal (readFile $filePath) -}}
  {{- $localeMap := dict -}}
  {{- range $entry := $entries -}}
    {{- $id := $entry.id | default $entry.Id -}}
    {{- $translation := $entry.translation | default $entry.Translation -}}
    {{- if and $id (not (in $localeMap $id)) -}}
      {{- $localeMap = merge $localeMap (dict $id $translation) -}}
    {{- end -}}
  {{- end -}}
  {{- $translationBundle = merge $translationBundle (dict $code $localeMap) -}}
{{- end -}}
<script id="facodi-translations" type="application/json">{{ $translationBundle | jsonify | safeHTML }}</script>
<script id="facodi-config" type="application/json">{{ dict "supabaseUrl" $supabaseUrl "supabaseAnonKey" $supabaseAnon "defaultLocale" $defaultLocale "locales" $locales | jsonify | safeHTML }}</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" integrity="sha384-AkNSQdptcXlJ0/NBZc4qGk86cDVXcCevwoWgEKIpHOEfbvlXGLlIkimQtONt8KNf" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/marked@12/marked.min.js" integrity="sha384-/TQbtLCAerC3jgaim+N78RZSDYV7ryeoBCVqTuzRrFec2akfBkHS7ACQ3PQhvMVi" crossorigin="anonymous"></script>
{{ $customScript := resources.Get "js/custom.js" | js.Build (dict "format" "iife" "target" "es2017") }}
<script src="{{ $customScript.RelPermalink }}" defer></script>
<script src="{{ "js/supabaseClient.js" | relURL }}" defer></script>
<script src="{{ "js/loaders.js" | relURL }}" defer></script>
<script>
  window.facodiGoogleTranslateInit = function () {
    if (!window.google || !window.google.translate) {
      return;
    }
    var bundle = document.getElementById('facodi-config');
    var locales = [];
    if (bundle) {
      try {
        var config = JSON.parse(bundle.textContent || bundle.innerText || '{}');
        locales = (config.locales || []).map(function (locale) {
          return locale.google || locale.code;
        });
      } catch (error) {
        locales = [];
      }
    }
    var targetLanguages = locales.filter(function (code) {
      return code && code !== 'pt';
    }).join(',');
    window.facodiGoogleTranslateElement = new google.translate.TranslateElement({
      pageLanguage: 'pt',
      autoDisplay: false,
      includedLanguages: targetLanguages
    }, 'google_translate_element');
    document.dispatchEvent(new CustomEvent('facodi:googleTranslateReady'));
  };
</script>
<script src="//translate.google.com/translate_a/element.js?cb=facodiGoogleTranslateInit" defer></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    if (!window.facodiLoaders) {
      return;
    }
    const body = document.body || {};
    const dataset = body.dataset || {};
    const datasetContext = {
      courseCode: dataset.course || undefined,
      planVersion: dataset.plan || undefined,
      ucCode: dataset.uc || undefined,
      topicSlug: dataset.topic || undefined,
    };
    const runtimeContext = window.facodiPageContext || {};
    const ctx = Object.assign({}, datasetContext, runtimeContext);
    if (ctx.courseCode) {
      window.facodiLoaders.loadCoursePage(ctx.courseCode, ctx.planVersion);
    }
    if (ctx.ucCode) {
      window.facodiLoaders.loadUCPage(ctx.ucCode);
    }
    if (ctx.topicSlug) {
      window.facodiLoaders.loadTopicPage(ctx.topicSlug);
    }
  });
</script>
