{{- /* Simplified Math render hook compatible with Hugo < 0.141.0. */ -}}

{{- $attrs := .Attributes -}}
{{- $inner := trim .Inner "\n\r" -}}
{{- $ordinal := .Ordinal -}}

{{- $displayMode := true -}}
{{- if or (strings.HasPrefix $inner `$$`) (strings.HasPrefix $inner `\[`) -}}
  {{- $displayMode = true -}}
{{- else if or (strings.HasPrefix $inner `$`) (strings.HasPrefix $inner `\(`) -}}
  {{- $displayMode = false -}}
{{- end -}}

{{- $inner = trim $inner `$` -}}
{{- $inner = $inner | strings.TrimPrefix `\[` -}}
{{- $inner = $inner | strings.TrimPrefix `\(` -}}
{{- $inner = $inner | strings.TrimSuffix `\]` -}}
{{- $inner = $inner | strings.TrimSuffix `\)` -}}

{{- $class := "math math-inline" -}}
{{- if $displayMode -}}
  {{- $class = "math math-block" -}}
{{- end -}}
{{- with $attrs.class -}}
  {{- $class = printf "%s %s" $class . -}}
{{- end -}}

{{- $id := printf "h-rh-cb-math-%d" $ordinal -}}
{{- with $attrs.id -}}
  {{- $id = . -}}
{{- end -}}

{{- $attrs = merge $attrs (dict "class" $class "id" $id) -}}

{{- $apiEndpoint := "https://math.vercel.app/" -}}
{{- $color := $attrs.color | default "" -}}
{{- $mode := cond $displayMode "from" "inline" -}}
{{- $qs := querify $mode $inner "color" $color -}}
{{- $url := printf "%s?%s" $apiEndpoint $qs -}}

{{- with resources.GetRemote $url -}}
  {{- $url = .RelPermalink -}}
{{- end -}}

<span
  {{- range $k, $v := $attrs -}}
    {{- if not (eq $k "color") -}}
      {{- if $v -}}
        {{- printf " %s=%q" $k (string $v) | safeHTMLAttr -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}>
  <img src="{{ $url }}" alt="mathematical expression or equation">
</span>
