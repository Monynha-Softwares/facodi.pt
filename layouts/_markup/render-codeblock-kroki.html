{{- /* Fallback render hook for Kroki diagrams compatible with Hugo versions prior to 0.141.0. */ -}}

{{- $attrs := .Attributes -}}
{{- $inner := trim .Inner "\n\r" -}}
{{- $ordinal := .Ordinal -}}
{{- $diagramType := ($attrs.type | default "") | lower -}}

{{- if not $diagramType -}}
  {{- highlight $inner (.Type | default "text") "" -}}
{{- else -}}
  {{- $supportedTypes := slice
    "actdiag" "blockdiag" "bpmn" "bytefield" "ditaa" "d2" "dbml" "erd" "graphviz"
    "mermaid" "nomnoml" "nwdiag" "packetdiag" "pikchr" "plantuml" "rackdiag"
    "seqdiag" "structurizr" "svgbob" "umlet" "vega" "vegalite" "wavedrom"
    "wireviz"
  -}}
  {{- if and $diagramType (not (in $supportedTypes $diagramType)) -}}
    {{- errorf "Unsupported Kroki diagram type %q. Supported types: %s" $attrs.type (delimit $supportedTypes ", " ", and ") -}}
  {{- end -}}

  {{- $class := printf "diagram diagram-kroki diagram-kroki-%s" $diagramType -}}
  {{- with $attrs.class -}}
    {{- $class = printf "%s %s" $class . -}}
  {{- end -}}

  {{- $id := printf "h-rh-cb-kroki-%d" $ordinal -}}
  {{- with $attrs.id -}}
    {{- $id = . -}}
  {{- end -}}

  {{- $attrs = merge $attrs (dict "class" $class "id" $id "alt" "diagram") -}}

  {{- $apiEndpoint := or site.Params.doks.krokiURL "https://kroki.io/" -}}
  {{- $body := dict "diagram_source" $inner "diagram_type" $diagramType "output_format" "SVG" | jsonify -}}
  {{- $opts := dict "method" "post" "body" $body -}}

  {{- with resources.GetRemote $apiEndpoint $opts -}}
    {{- $attrs = merge $attrs (dict "src" .RelPermalink) -}}
  {{- else -}}
    {{- errorf "Failed to fetch Kroki diagram for %q" $diagramType -}}
  {{- end -}}

  <img
    {{- range $k, $v := $attrs -}}
      {{- if not (eq $k "type") -}}
        {{- if $v -}}
          {{- printf " %s=%q" $k (string $v) | safeHTMLAttr -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}>
{{- end -}}
