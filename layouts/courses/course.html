{{ define "main" }}
{{ $params := .Params }}
{{ $ucParamList := $params.ucs | default (slice) }}
<section class="section container py-5">
  <div class="row justify-content-center mb-5">
    <div class="col-lg-10">
      <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-4">
        <div>
          <span class="badge bg-primary-subtle text-primary fw-semibold">{{ $params.code }}</span>
          {{ with $params.plan_version }}
          <span class="badge bg-info-subtle text-info ms-2">Plano {{ . }}</span>
          {{ end }}
          <h1 class="display-5 mt-3">{{ .Title }}</h1>
          {{ with $params.summary }}<p class="lead text-muted mb-0" data-facodi-course-summary>{{ . }}</p>{{ end }}
        </div>
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <dl class="row mb-0 small">
              <dt class="col-6 col-lg-5">Grau</dt>
              <dd class="col-6 col-lg-7 text-lg-end">{{ $params.degree | default "--" }}</dd>
              <dt class="col-6 col-lg-5">ECTS totais</dt>
              <dd class="col-6 col-lg-7 text-lg-end">{{ $params.ects_total | default "--" }}</dd>
              <dt class="col-6 col-lg-5">Duração</dt>
              <dd class="col-6 col-lg-7 text-lg-end">{{ $params.duration_semesters | default "--" }} semestres</dd>
              <dt class="col-6 col-lg-5">Idioma</dt>
              <dd class="col-6 col-lg-7 text-lg-end">{{ $params.language | default "--" }}</dd>
              <dt class="col-6 col-lg-5">Instituição</dt>
              <dd class="col-6 col-lg-7 text-lg-end">{{ $params.institution | default "--" }}</dd>
              <dt class="col-6 col-lg-5">Escola</dt>
              <dd class="col-6 col-lg-7 text-lg-end">{{ $params.school | default "--" }}</dd>
            </dl>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="content mb-5">{{ .Content }}</div>
      <hr class="my-5" />
      <div class="d-flex align-items-center justify-content-between mb-4">
        <h2 class="h3 mb-0">Unidades Curriculares</h2>
        <span class="text-muted small" id="course-uc-count">{{ len $ucParamList }} unidades</span>
      </div>
      {{ $scratch := newScratch }}
      {{ $scratch.Set "ucs" (slice) }}
      {{ range $ucParamList }}
        {{ $ref := .ref | default (printf "/courses/%s/uc/%s/" (lower $params.code) (lower .code)) }}
        {{ with site.GetPage "page" $ref }}
          {{ $scratch.Add "ucs" (slice .) }}
        {{ else }}
          {{ with site.GetPage (strings.TrimPrefix "/" $ref) }}
            {{ $scratch.Add "ucs" (slice .) }}
          {{ end }}
        {{ end }}
      {{ end }}
      {{ $ucPages := $scratch.Get "ucs" }}
      {{ if not (len $ucPages) }}
      <div class="alert alert-warning" role="alert" data-facodi-slot="course-ucs">
        Ainda não adicionamos unidades curriculares por aqui. Bora sugerir playlists e conteúdos para abrir essa trilha?
      </div>
      {{ else }}
      {{ $groups := newScratch }}
      {{ $groups.Set "years" (slice) }}
      {{ range $ucPages }}
        {{ $ucPage := . }}
        {{ $ucParams := $ucPage.Params }}
        {{ $rawSemester := int (default 1 $ucParams.semester) }}
        {{ $computedYear := add (div (sub $rawSemester 1) 2) 1 }}
        {{ $year := int (default $computedYear $ucParams.year) }}
        {{ $relativeSemester := $rawSemester }}
        {{ if gt $rawSemester 2 }}
          {{ $relativeSemester = add (mod (sub $rawSemester 1) 2) 1 }}
        {{ end }}
        {{ $relativeSemester = int $relativeSemester }}
        {{ $existingYears := $groups.Get "years" | default (slice) }}
        {{ if not (in $existingYears $year) }}
          {{ $groups.Set "years" (append $existingYears $year) }}
        {{ end }}
        {{ $mapKey := printf "%d-%d" $year $relativeSemester }}
        {{ $existing := $groups.Get $mapKey | default (slice) }}
        {{ $groups.Set $mapKey (append $existing $ucPage) }}
      {{ end }}
      {{ $years := sort ($groups.Get "years" | default (slice)) }}
      <div id="course-ucs" data-facodi-slot="course-ucs" class="facodi-uc-groups">
        {{ range $years }}
          {{ $year := . }}
          {{ $yearHeadingID := printf "course-year-%d" $year }}
          <section class="facodi-uc-year" aria-labelledby="{{ $yearHeadingID }}">
            <header class="facodi-uc-year__header section-header">
              <h2 id="{{ $yearHeadingID }}" class="section-title">Ano {{ $year }}</h2>
            </header>
            {{ range $semester := slice 1 2 }}
              {{ $semesterKey := printf "%d-%d" $year $semester }}
              {{ $semesterPages := $groups.Get $semesterKey }}
              {{ if $semesterPages }}
                {{ $semesterHeadingID := printf "course-year-%d-sem-%d" $year $semester }}
                <div class="facodi-uc-semester" aria-labelledby="{{ $semesterHeadingID }}">
                  <h3 id="{{ $semesterHeadingID }}" class="facodi-uc-semester__title">Semestre {{ $semester }}</h3>
                  <div class="facodi-uc-grid">
                    {{ range sort $semesterPages "Params.code" }}
                      {{ $ucPage := . }}
                      {{ $ucParams := $ucPage.Params }}
                      <article class="facodi-uc-card" data-uc-code="{{ $ucParams.code }}">
                        <div class="facodi-uc-card__header">
                          {{ with $ucParams.code }}<span class="facodi-uc-card__code">{{ . }}</span>{{ end }}
                          {{ with $ucParams.semester }}<span class="facodi-uc-card__semester">Semestre {{ . }}</span>{{ end }}
                        </div>
                        <h3 class="facodi-uc-card__title"><a class="facodi-uc-card__link" href="{{ $ucPage.RelPermalink }}">{{ $ucPage.Title }}</a></h3>
                        {{ with $ucParams.description }}<p class="facodi-uc-card__summary">{{ . }}</p>{{ end }}
                        <dl class="facodi-uc-card__meta">
                          <div>
                            <dt>ECTS</dt>
                            <dd>{{ $ucParams.ects | default "--" }}</dd>
                          </div>
                          <div>
                            <dt>Idioma</dt>
                            <dd>{{ $ucParams.language | default "--" }}</dd>
                          </div>
                        </dl>
                      </article>
                    {{ end }}
                  </div>
                </div>
              {{ end }}
            {{ end }}
          </section>
        {{ end }}
      </div>
      {{ end }}
    </div>
  </div>
</section>
<script>
window.facodiPageContext = Object.assign(window.facodiPageContext || {}, {
  courseCode: {{ $params.code | default "" | jsonify }},
  planVersion: {{ $params.plan_version | default "" | jsonify }}
});
</script>
{{ end }}
